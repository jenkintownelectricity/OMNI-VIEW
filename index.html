<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OMNI-VIEW v2.0 | Ultimate Construction Document Platform</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://unpkg.com/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* ═══════════════════════════════════════════════════════════════════
   OMNI-VIEW v2.0 — DARK MATTER THEME
   ═══════════════════════════════════════════════════════════════════ */
:root{
  --bg:#0f1115;--bg2:#161b22;--bg3:#1c2028;--bg4:#252a35;--bgh:#2a3040;
  --hdr:#0d1117;--inp:#0d1117;
  --bdr:#30363d;--bdr2:#3a414b;
  --acc:#4fa3f7;--acc2:#6db5ff;--accd:rgba(79,163,247,.12);
  --org:#ff6b35;--red:#da3633;--grn:#34d399;--ylw:#fbbf24;--hl:#1f6feb;
  --tx:#e6edf3;--tx2:#8b949e;--tx3:#555d70;
  --r:5px;--sh:0 4px 20px rgba(0,0,0,.5);
  --f:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  --m:'SF Mono','Cascadia Code','Fira Code',Consolas,monospace;
  --top:42px;--tb:38px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:var(--f);font-size:13px;color:var(--tx);background:var(--bg);-webkit-font-smoothing:antialiased}
button{cursor:pointer;font:inherit;border:none;background:none;color:inherit}
input,select{font:inherit;color:var(--tx);background:var(--inp);border:1px solid var(--bdr);padding:4px 7px;font-size:11px;outline:none;border-radius:3px;width:100%}
input:focus,select:focus{border-color:var(--acc)}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#2a2f3a;border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:#3a414b}

/* TOP BAR */
.top-bar{height:var(--top);background:var(--hdr);border-bottom:1px solid var(--bdr);display:flex;align-items:center;padding:0 10px;justify-content:space-between;flex-shrink:0;user-select:none;z-index:100}
.logo{font-weight:800;color:var(--org);display:flex;align-items:center;gap:6px;font-size:14px;letter-spacing:1px}
.logo .v{opacity:.4;font-size:10px;font-weight:400;letter-spacing:0}
.top-acts{display:flex;gap:5px;align-items:center}
.abtn{background:var(--hl);color:#fff;border:none;padding:5px 12px;border-radius:var(--r);font-size:11px;font-weight:700;transition:background .15s;display:inline-flex;align-items:center;gap:4px}
.abtn:hover{background:#3b82f6}
.abtn.danger{background:var(--red)}
.abtn.grn{background:#059669}
.abtn.org{background:var(--org)}
.abtn .material-icons-round{font-size:15px}
.abtn:disabled{opacity:.35;pointer-events:none}

/* GRID */
.app{display:grid;grid-template-columns:240px 1fr 300px;height:calc(100vh - var(--top))}

/* EXPLORER */
.expl{background:var(--bg);border-right:1px solid var(--bdr);display:flex;flex-direction:column;overflow:hidden}
.expl-hdr{padding:6px 8px;border-bottom:1px solid var(--bdr);display:flex;gap:5px;align-items:center}
.expl-hdr input{flex:1}
.flist{flex:1;overflow-y:auto;padding:3px}
.fi{padding:4px 7px;font-size:11px;color:var(--tx2);cursor:pointer;display:flex;align-items:center;gap:6px;border-radius:3px;border:1px solid transparent;transition:background .1s}
.fi:hover{background:rgba(255,255,255,.05);color:var(--tx)}
.fi.act{background:rgba(31,111,235,.2);border-color:var(--hl);color:#fff}
.fi .ic{font-size:15px;flex-shrink:0}
.fi .fn{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fi .fs{font-size:9px;color:var(--tx3);font-family:var(--m);flex-shrink:0}
.fdr{padding:4px 7px;font-size:11px;font-weight:600;color:var(--ylw);cursor:pointer;display:flex;align-items:center;gap:5px;border-radius:3px}
.fdr:hover{background:rgba(255,255,255,.04)}
.fdr .material-icons-round{font-size:15px;transition:transform .15s}
.fdr.col .material-icons-round:first-child{transform:rotate(-90deg)}
.fdr+.fch.chid{display:none}
.fch{padding-left:12px}

/* CANVAS AREA */
.cvs-area{display:flex;flex-direction:column;overflow:hidden;position:relative;background:#222}

/* Toolbar */
.toolbar{height:var(--tb);background:#1e1e20;border-bottom:1px solid var(--bdr);display:flex;align-items:center;gap:2px;padding:0 6px;z-index:10;flex-shrink:0;overflow-x:auto}
.tbtn{width:30px;height:30px;border:1px solid transparent;background:transparent;color:#999;border-radius:3px;display:flex;align-items:center;justify-content:center;transition:all .1s;flex-shrink:0;position:relative}
.tbtn:hover{background:rgba(255,255,255,.1);color:#fff}
.tbtn.on{background:var(--org);color:#000;box-shadow:0 0 8px var(--org)}
.tbtn .material-icons-round{font-size:17px}
.tsep{width:1px;height:18px;background:#444;margin:0 2px;flex-shrink:0}
.tbtn[title]:hover::after{content:attr(title);position:absolute;top:100%;left:50%;transform:translateX(-50%);background:#000;color:#ccc;padding:2px 6px;font-size:9px;white-space:nowrap;border-radius:3px;margin-top:4px;z-index:100;pointer-events:none}
.zlbl{font-size:10px;font-family:var(--m);color:var(--tx2);min-width:40px;text-align:center;user-select:none}

/* Viewer */
.viewer{flex:1;display:flex;overflow:hidden;position:relative}
.viewer.split .sv{width:50%;border-right:1px solid var(--org)}

/* Thumb bar */
.thbar{width:120px;background:#18181c;border-right:1px solid var(--bdr);overflow-y:auto;padding:8px 6px;display:flex;flex-direction:column;gap:8px;flex-shrink:0}
.th{width:100%;aspect-ratio:.77;background:#fff;opacity:.5;cursor:pointer;position:relative;border:2px solid transparent;transition:.15s;border-radius:2px;overflow:hidden}
.th:hover{opacity:.8;border-color:#555}
.th.on{opacity:1;border-color:var(--org);box-shadow:0 0 6px rgba(255,107,53,.3)}
.th canvas{width:100%!important;height:100%!important;display:block}
.th .pn{position:absolute;bottom:1px;right:2px;background:rgba(0,0,0,.7);color:#fff;font-size:8px;padding:1px 4px;border-radius:2px;font-family:var(--m)}

/* Scroll view */
.sv{flex:1;overflow:auto;padding:24px;display:flex;flex-direction:column;align-items:center;gap:20px;background-image:radial-gradient(#333 1px,transparent 1px);background-size:20px 20px}

/* Page wrap */
.pw{position:relative;box-shadow:0 6px 24px rgba(0,0,0,.5);background:#fff;border-radius:1px}
.pw canvas.pdf{display:block}
.pw .canvas-container{position:absolute!important;top:0;left:0}

/* Empty */
.empty{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:var(--tx3);pointer-events:none;z-index:1}
.empty .material-icons-round{font-size:56px;opacity:.2;display:block;margin-bottom:10px}

/* RIGHT PANEL */
.rpanel{background:var(--bg2);border-left:1px solid var(--bdr);display:flex;flex-direction:column;overflow-y:auto;font-size:11px}
.rtab-bar{display:flex;border-bottom:1px solid var(--bdr);flex-shrink:0}
.rtab{flex:1;padding:7px 4px;text-align:center;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--tx3);cursor:pointer;border-bottom:2px solid transparent;transition:.15s}
.rtab:hover{color:var(--tx2)}
.rtab.on{color:var(--acc);border-color:var(--acc)}
.rpane{display:none;flex-direction:column;gap:6px;padding:8px;flex:1;overflow-y:auto}
.rpane.on{display:flex}
.rlbl{font-size:9px;text-transform:uppercase;color:var(--tx2);font-weight:700;letter-spacing:.7px;margin-bottom:2px}
.rhint{font-size:9px;color:var(--tx3);font-family:var(--m);margin-bottom:4px}
.rsec{border-bottom:1px solid var(--bdr);padding-bottom:7px;margin-bottom:3px}
.chiprow{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:3px}
.chip{background:rgba(31,111,235,.12);border:1px solid transparent;color:#7eb8f0;font-size:9px;padding:2px 6px;border-radius:10px;cursor:pointer;font-family:var(--m);font-weight:600;transition:all .1s}
.chip:hover{background:rgba(31,111,235,.25);color:#a5d6ff}
.chip.on{background:var(--accd);border-color:var(--acc);color:var(--acc)}
.pvbox{font-family:var(--m);font-size:11px;font-weight:600;color:var(--acc);padding:6px 8px;background:var(--accd);border:1px solid rgba(79,163,247,.2);border-radius:3px;word-break:break-all;min-height:24px}
.rbtn{padding:6px 10px;border-radius:var(--r);font-size:11px;font-weight:700;width:100%;transition:background .15s;text-align:center}
.rbtn.pri{background:var(--hl);color:#fff}
.rbtn.pri:hover{background:#3b82f6}
.rbtn.pri:disabled{opacity:.35;pointer-events:none}
.rbtn.sec{background:#2a2f3a;color:var(--tx2)}
.rbtn.sec:hover{background:#353b48;color:var(--tx)}
.hi{font-size:9px;font-family:var(--m);padding:2px 0;border-bottom:1px solid var(--bdr);color:var(--tx3);display:flex;gap:3px}
.hi .ho{color:var(--red);text-decoration:line-through;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.hi .hn{color:var(--grn);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* Measurement overlay text */
.meas-label{position:absolute;background:rgba(0,0,0,.8);color:#0f0;font-size:10px;font-family:var(--m);padding:1px 5px;border-radius:2px;pointer-events:none;white-space:nowrap;z-index:50}

/* CONTEXT MENU */
.ctx{position:fixed;display:none;background:var(--bg3);border:1px solid var(--bdr);border-radius:var(--r);box-shadow:var(--sh);z-index:2000;min-width:170px;padding:3px 0;font-size:12px}
.ctx button{display:block;width:100%;padding:5px 14px;text-align:left;background:transparent;color:var(--tx);transition:background .1s}
.ctx button:hover{background:var(--bgh)}
.ctx .sep{height:1px;background:var(--bdr);margin:3px 0}

/* TOAST */
#toast{position:fixed;bottom:14px;right:14px;z-index:9999;display:flex;flex-direction:column-reverse;gap:5px}
.tst{padding:8px 14px;border-radius:var(--r);font-size:11px;font-weight:500;box-shadow:var(--sh);animation:tin .2s ease-out;max-width:340px;word-break:break-word}
.tst.ok{background:#065f46;color:#d1fae5;border-left:3px solid var(--grn)}
.tst.er{background:#7f1d1d;color:#fecaca;border-left:3px solid var(--red)}
.tst.in{background:#1e3a5f;color:#bfdbfe;border-left:3px solid var(--acc)}
.tst.wr{background:#78350f;color:#fef3c7;border-left:3px solid var(--ylw)}
@keyframes tin{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.tst.out{animation:tout .2s forwards}
@keyframes tout{to{opacity:0;transform:translateY(8px)}}

/* PROGRESS BAR */
.pbar{height:3px;background:var(--bdr);border-radius:2px;overflow:hidden;margin:4px 0}
.pbar .pfill{height:100%;background:var(--acc);transition:width .3s;width:0}

/* MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:5000}
.modal-bg.show{display:flex}
.modal{background:var(--bg3);border:1px solid var(--bdr);border-radius:8px;box-shadow:var(--sh);min-width:340px;max-width:460px;width:90%}
.modal-hd{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid var(--bdr);font-weight:700;font-size:13px}
.modal-bd{padding:14px}
.modal-ft{display:flex;justify-content:flex-end;gap:6px;padding:10px 14px;border-top:1px solid var(--bdr)}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="top-bar">
  <div class="logo"><span class="material-icons-round">bolt</span>OMNI-VIEW<span class="v">v2.0 ULTIMATE</span></div>
  <div class="top-acts">
    <button class="abtn" onclick="undo()" title="Undo (Ctrl+Z)"><span class="material-icons-round">undo</span></button>
    <button class="abtn" onclick="redo()" title="Redo (Ctrl+Y)"><span class="material-icons-round">redo</span></button>
    <span style="width:1px;height:20px;background:var(--bdr);margin:0 2px"></span>
    <button class="abtn org" onclick="rotatePage()" title="Rotate Page 90° CW"><span class="material-icons-round">rotate_right</span>Rotate</button>
    <button class="abtn" onclick="extractPage()" title="Extract Current Page"><span class="material-icons-round">file_download</span>Extract</button>
    <button class="abtn grn" onclick="flattenPage()" title="Flatten Markups into PDF"><span class="material-icons-round">layers_clear</span>Flatten</button>
    <button class="abtn" onclick="runOCR()" title="OCR Current Page"><span class="material-icons-round">document_scanner</span>OCR</button>
    <span style="width:1px;height:20px;background:var(--bdr);margin:0 2px"></span>
    <button class="abtn" onclick="toggleSplit()" title="Split View"><span class="material-icons-round">vertical_split</span></button>
    <button class="abtn" onclick="openProject()"><span class="material-icons-round">folder_open</span>Open</button>
  </div>
</div>

<!-- MAIN GRID -->
<div class="app">

<!-- LEFT: EXPLORER -->
<div class="expl">
  <div class="expl-hdr">
    <span class="material-icons-round" style="font-size:14px;color:var(--tx3)">search</span>
    <input type="text" id="srch" placeholder="Filter..." oninput="filterFiles()">
  </div>
  <div id="flist" class="flist">
    <div id="emp" style="padding:24px;text-align:center;opacity:.35">
      <span class="material-icons-round" style="font-size:36px;display:block;margin-bottom:6px">folder_open</span>Open a project folder
    </div>
  </div>
</div>

<!-- CENTER: CANVAS -->
<div class="cvs-area">
  <div class="toolbar" id="toolbar">
    <button class="tbtn on" data-t="cursor" title="Select" onclick="setTool('cursor')"><span class="material-icons-round">near_me</span></button>
    <div class="tsep"></div>
    <button class="tbtn" data-t="pen" title="Pen (Red)" onclick="setTool('pen')"><span class="material-icons-round">edit</span></button>
    <button class="tbtn" data-t="highlighter" title="Highlighter" onclick="setTool('highlighter')"><span class="material-icons-round">border_color</span></button>
    <button class="tbtn" data-t="text" title="Text Box" onclick="setTool('text')"><span class="material-icons-round">title</span></button>
    <div class="tsep"></div>
    <button class="tbtn" data-t="arrow" title="Arrow" onclick="setTool('arrow')"><span class="material-icons-round">north_east</span></button>
    <button class="tbtn" data-t="rect" title="Rectangle" onclick="setTool('rect')"><span class="material-icons-round">crop_square</span></button>
    <button class="tbtn" data-t="polyline" title="Polyline (click, dblclick end)" onclick="setTool('polyline')"><span class="material-icons-round">timeline</span></button>
    <button class="tbtn" data-t="cloud" title="Revision Cloud" onclick="setTool('cloud')"><span class="material-icons-round">cloud_queue</span></button>
    <button class="tbtn" data-t="callout" title="Callout (Text+Arrow)" onclick="setTool('callout')"><span class="material-icons-round">chat_bubble_outline</span></button>
    <button class="tbtn" data-t="stamp" title="Insert Image Stamp" onclick="setTool('stamp')"><span class="material-icons-round">add_photo_alternate</span></button>
    <div class="tsep"></div>
    <button class="tbtn" data-t="calibrate" title="Calibrate Scale" onclick="setTool('calibrate')"><span class="material-icons-round">straighten</span></button>
    <button class="tbtn" data-t="dimension" title="Dimension Line" onclick="setTool('dimension')"><span class="material-icons-round">square_foot</span></button>
    <button class="tbtn" data-t="area" title="Area Measure (polygon)" onclick="setTool('area')"><span class="material-icons-round">pentagon</span></button>
    <button class="tbtn" data-t="count" title="Count Tool" onclick="setTool('count')"><span class="material-icons-round">pin</span></button>
    <div class="tsep"></div>
    <button class="tbtn" data-t="eraser" title="Delete Selected" onclick="setTool('eraser')"><span class="material-icons-round">delete_outline</span></button>
    <div class="tsep"></div>
    <button class="tbtn" title="Zoom Out" onclick="chZoom(-.25)"><span class="material-icons-round">remove</span></button>
    <span class="zlbl" id="zlbl">100%</span>
    <button class="tbtn" title="Zoom In" onclick="chZoom(.25)"><span class="material-icons-round">add</span></button>
    <button class="tbtn" title="Fit Width" onclick="fitW()"><span class="material-icons-round">fit_screen</span></button>
  </div>

  <div class="viewer" id="viewer">
    <div class="thbar" id="thbar"></div>
    <div class="sv" id="sv">
      <div class="empty" id="emSt"><span class="material-icons-round">description</span><div style="font-size:15px;font-weight:700;margin-bottom:3px">OMNI-VIEW v2.0</div><div>Select a PDF or image</div></div>
    </div>
  </div>
</div>

<!-- RIGHT PANEL -->
<div class="rpanel">
  <div class="rtab-bar">
    <div class="rtab on" data-tab="tools" onclick="showTab('tools')">Tools</div>
    <div class="rtab" data-tab="rename" onclick="showTab('rename')">Rename</div>
    <div class="rtab" data-tab="data" onclick="showTab('data')">Data</div>
  </div>

  <!-- TOOLS PANE -->
  <div class="rpane on" id="pane-tools">
    <div class="rsec">
      <span class="rlbl">Active File</span>
      <div id="afn" style="font-family:var(--m);font-size:10px;color:var(--tx2);padding:4px 6px;background:var(--inp);border-radius:3px;word-break:break-all;min-height:20px">None</div>
    </div>
    <div class="rsec">
      <span class="rlbl">Calibration</span>
      <div style="display:flex;gap:4px;align-items:center">
        <input type="number" id="calVal" value="10" min="0.1" step="0.1" style="width:60px">
        <select id="calUnit" style="width:60px"><option>ft</option><option>m</option><option>in</option><option>cm</option></select>
        <span id="calSt" style="font-size:9px;color:var(--tx3)">Not calibrated</span>
      </div>
    </div>
    <div class="rsec">
      <span class="rlbl">Measurements</span>
      <div id="measList" style="max-height:100px;overflow-y:auto;font-size:10px;font-family:var(--m);color:var(--tx2)">No measurements</div>
    </div>
    <div class="rsec">
      <span class="rlbl">Count</span>
      <div style="display:flex;align-items:center;gap:8px">
        <span id="countVal" style="font-size:20px;font-weight:800;color:var(--org)">0</span>
        <button class="abtn" style="font-size:10px;padding:3px 8px" onclick="resetCount()">Reset</button>
      </div>
    </div>
    <div class="rsec">
      <span class="rlbl">OCR Progress</span>
      <div class="pbar"><div class="pfill" id="ocrBar"></div></div>
      <div id="ocrSt" style="font-size:9px;color:var(--tx3)">Idle</div>
    </div>
  </div>

  <!-- RENAME PANE -->
  <div class="rpane" id="pane-rename">
    <div class="rsec">
      <span class="rlbl">Current File</span>
      <div id="rcur" style="font-family:var(--m);font-size:10px;color:var(--tx2);padding:4px 6px;background:var(--inp);border-radius:3px;word-break:break-all">None</div>
    </div>
    <div class="rsec">
      <span class="rlbl">Preview</span>
      <div class="pvbox" id="rpv">—</div>
    </div>
    <div class="rsec">
      <span class="rlbl">Taxonomy</span>
      <div class="rhint">Class–Rev–Ver–Spec–Date–Client–Job–Desc</div>

      <span class="rlbl" style="margin-top:4px">Class</span>
      <div class="chiprow" id="cClass"></div>
      <span class="rlbl">Revision</span>
      <div class="chiprow" id="cRev"></div>
      <span class="rlbl">Version</span>
      <div class="chiprow" id="cVer"></div>
      <span class="rlbl">Discipline</span>
      <div class="chiprow" id="cSpec"></div>

      <div style="display:flex;gap:4px;margin-top:4px">
        <div style="flex:1"><span class="rlbl">Date</span><div style="display:flex;gap:3px"><input type="date" id="txDt"><button class="abtn" style="font-size:9px;padding:2px 6px;flex-shrink:0" onclick="setToday()">TODAY</button></div></div>
      </div>
      <div style="display:flex;gap:4px;margin-top:3px">
        <div style="flex:1"><span class="rlbl">Client</span><input id="txCl" placeholder="ACME" maxlength="20" oninput="updPv()"></div>
        <div style="flex:1"><span class="rlbl">Job</span><input id="txJb" placeholder="2024-0150" maxlength="20" oninput="updPv()"></div>
      </div>
      <div style="margin-top:3px"><span class="rlbl">Description</span><input id="txDs" placeholder="FloorPlan-L2" maxlength="60" oninput="updPv()"></div>
    </div>
    <button class="rbtn pri" id="renBtn" disabled onclick="doRename()"><span class="material-icons-round" style="font-size:13px;vertical-align:middle;margin-right:3px">drive_file_rename_outline</span>RENAME</button>
    <button class="rbtn sec" onclick="clrTax()">Clear</button>
    <div style="margin-top:4px"><span class="rlbl">History</span><div id="rHist" style="max-height:100px;overflow-y:auto"></div></div>
  </div>

  <!-- DATA PANE -->
  <div class="rpane" id="pane-data">
    <div class="rsec">
      <span class="rlbl">Excel Link</span>
      <button class="abtn" style="width:100%;justify-content:center" onclick="linkExcel()"><span class="material-icons-round">table_chart</span>Load .xlsx</button>
      <div id="xlName" style="font-size:10px;color:var(--tx3);margin-top:3px;font-family:var(--m)">No file linked</div>
    </div>
    <div class="rsec">
      <span class="rlbl">Export Measurements to Excel</span>
      <button class="abtn grn" style="width:100%;justify-content:center" onclick="exportXL()"><span class="material-icons-round">file_download</span>Export</button>
    </div>
    <div class="rsec">
      <span class="rlbl">Linked Data Preview</span>
      <div id="xlPv" style="font-size:10px;font-family:var(--m);color:var(--tx2);max-height:200px;overflow:auto">No data</div>
    </div>
  </div>
</div>

</div><!-- /app -->

<!-- CONTEXT MENU -->
<div class="ctx" id="ctx"></div>

<!-- TOAST -->
<div id="toast"></div>

<!-- CALIBRATE MODAL -->
<div class="modal-bg" id="calModal">
  <div class="modal">
    <div class="modal-hd">Calibrate Scale<button onclick="closeCalModal()" style="color:var(--tx2)">&times;</button></div>
    <div class="modal-bd">
      <p style="font-size:12px;color:var(--tx2);margin-bottom:8px">You drew a line. Enter its real-world length:</p>
      <div style="display:flex;gap:6px;align-items:center">
        <input type="number" id="calInput" value="10" min="0.1" step="0.1" style="width:80px">
        <select id="calUnitM" style="width:70px"><option>ft</option><option>m</option><option>in</option><option>cm</option></select>
      </div>
    </div>
    <div class="modal-ft">
      <button class="abtn sec" onclick="closeCalModal()">Cancel</button>
      <button class="abtn" onclick="confirmCal()">Calibrate</button>
    </div>
  </div>
</div>

<script>
/* ═══════════════════════════════════════════════════════════════════
   OMNI-VIEW v2.0 — COMPLETE UNIFIED ENGINE
   ═══════════════════════════════════════════════════════════════════ */
'use strict';

// ─── GLOBAL STATE ────────────────────────────────────────────────
let dirHandle=null, allFiles=[], activeEntry=null, currentPdf=null;
let pages=[], scale=1.0, tool='cursor';
let isPan=false, spaceHeld=false, panO={x:0,y:0,sx:0,sy:0};
let splitMode=false, pdfBytes=null;

// Undo / Redo
const undoStack=[], redoStack=[], MAX_HIST=80;

// Measurement / Calibration
let calPixelsPerUnit=0, calUnit='ft', measurements=[], countVal=0;
let polyPts=[], calLine=null, areaPoints=[];

// Rename
const tax={class:'',rev:'',ver:'',spec:'',date:'',client:'',job:'',desc:''};
const renHist=[];

// Excel
let xlData=null, xlHandle=null;

// ─── TAXONOMY DATA ───────────────────────────────────────────────
const TAX_DATA={
  class:['DWG','SPEC','SUB','RFI','CO','ASI','SHOP','PHOTO','RPT','SCHED','CORR','LOG','PM','SAF','QC','MTG','INV','CALC'],
  rev:['R00','R01','R02','R03','R04','R05','RA','RB','RC','RD'],
  ver:['V1','V2','V3','DRAFT','FINAL','IFC','IFR','IFB','RECORD'],
  spec:['ARCH','STRUC','MEP','ELEC','MECH','PLMB','CIVIL','FIRE','GEN','LAND']
};

// ─── FILE TYPES ──────────────────────────────────────────────────
const FT={
  pdf:{ic:'picture_as_pdf',cl:'#e74c3c'},docx:{ic:'description',cl:'#3b82f6'},doc:{ic:'description',cl:'#3b82f6'},
  xlsx:{ic:'table_chart',cl:'#22c55e'},xls:{ic:'table_chart',cl:'#22c55e'},csv:{ic:'table_chart',cl:'#22c55e'},
  png:{ic:'image',cl:'#a855f7'},jpg:{ic:'image',cl:'#a855f7'},jpeg:{ic:'image',cl:'#a855f7'},gif:{ic:'image',cl:'#a855f7'},
  bmp:{ic:'image',cl:'#a855f7'},tif:{ic:'image',cl:'#a855f7'},tiff:{ic:'image',cl:'#a855f7'},svg:{ic:'image',cl:'#a855f7'},
  dwg:{ic:'architecture',cl:'#f59e0b'},dxf:{ic:'architecture',cl:'#f59e0b'},
  txt:{ic:'article',cl:'#8b949e'},rtf:{ic:'article',cl:'#8b949e'},
};
function ft(n){const e=n.lastIndexOf('.');const x=e>0?n.slice(e+1).toLowerCase():'';return FT[x]||{ic:'insert_drive_file',cl:'#555'};}
function fext(n){const e=n.lastIndexOf('.');return e>0?n.slice(e+1).toLowerCase():'';}
function fmtSz(b){if(!b)return'';const u=['B','KB','MB','GB'];const i=b?Math.floor(Math.log(b)/Math.log(1024)):0;return(b/Math.pow(1024,i)).toFixed(i?1:0)+' '+u[i];}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}

// ─── TOAST ───────────────────────────────────────────────────────
function toast(m,t='in',d=3000){const e=document.createElement('div');e.className='tst '+t;e.textContent=m;document.getElementById('toast').appendChild(e);setTimeout(()=>{e.classList.add('out');e.addEventListener('animationend',()=>e.remove());},d);}

// ═══════════════════════════════════════════════════════════════════
// FILE SYSTEM
// ═══════════════════════════════════════════════════════════════════
async function openProject(){
  if(!('showDirectoryPicker' in window)){toast('Use Chrome 86+ or Edge','er',5000);return;}
  try{
    dirHandle=await window.showDirectoryPicker({mode:'readwrite'});
    toast('Opened: '+dirHandle.name,'ok');
    await scanFiles();
  }catch(e){if(e.name!=='AbortError')toast(e.message,'er');}
}

async function scanFiles(){
  allFiles=[];await walk(dirHandle,'');renderFL();
}

async function walk(dh,pre){
  try{for await(const[n,h]of dh.entries()){
    const p=pre?pre+'/'+n:n;
    if(h.kind==='file'){let sz=0;try{sz=(await h.getFile()).size}catch{};allFiles.push({name:n,path:p,handle:h,parentHandle:dh,size:sz,ext:fext(n)});}
    else await walk(h,p);
  }}catch(e){toast('Read: '+e.message,'er');}
}

function renderFL(){
  const el=document.getElementById('flist'),emp=document.getElementById('emp');
  if(!allFiles.length){el.innerHTML='';el.appendChild(emp);emp.style.display='';return;}
  emp.style.display='none';
  const tree={};
  allFiles.forEach(f=>{const ps=f.path.split('/');const k=ps.length===1?'__r__':ps.slice(0,-1).join('/');(tree[k]=tree[k]||[]).push(f);});
  Object.values(tree).forEach(a=>a.sort((x,y)=>x.name.localeCompare(y.name)));
  el.innerHTML='';
  Object.keys(tree).sort((a,b)=>a==='__r__'?-1:b==='__r__'?1:a.localeCompare(b)).forEach(k=>{
    if(k!=='__r__'){
      const fd=document.createElement('div');fd.className='fdr';
      fd.innerHTML=`<span class="material-icons-round">expand_more</span><span class="material-icons-round" style="color:var(--ylw)">folder</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(k)}</span>`;
      const cd=document.createElement('div');cd.className='fch';
      fd.addEventListener('click',()=>{fd.classList.toggle('col');cd.classList.toggle('chid');});
      el.appendChild(fd);tree[k].forEach(f=>cd.appendChild(mkFI(f)));el.appendChild(cd);
    } else tree[k].forEach(f=>el.appendChild(mkFI(f)));
  });
}

function mkFI(f){
  const t=ft(f.name),d=document.createElement('div');
  d.className='fi';d.dataset.path=f.path;d.dataset.name=f.name.toLowerCase();
  d.innerHTML=`<span class="material-icons-round ic" style="color:${t.cl}">${t.ic}</span><span class="fn" title="${esc(f.path)}">${esc(f.name)}</span><span class="fs">${fmtSz(f.size)}</span>`;
  d.addEventListener('click',()=>loadFile(f,d));
  d.addEventListener('contextmenu',e=>{e.preventDefault();showCtx(e.clientX,e.clientY,f);});
  return d;
}

function filterFiles(){
  const q=document.getElementById('srch').value.toLowerCase();
  document.querySelectorAll('.fi').forEach(e=>{e.style.display=(e.dataset.name||'').includes(q)?'':'none';});
  document.querySelectorAll('.fdr').forEach(f=>{const c=f.nextElementSibling;if(!c)return;const v=[...c.querySelectorAll('.fi')].some(x=>x.style.display!=='none');f.style.display=v?'':'none';c.style.display=v?'':'none';});
}

// Context menu
function showCtx(x,y,f){
  const m=document.getElementById('ctx');
  m.innerHTML='';
  [{l:'Open',fn:()=>{const r=document.querySelector(`.fi[data-path="${CSS.escape(f.path)}"]`);loadFile(f,r);}},
   {l:'Batch Rename',fn:()=>{showTab('rename');const r=document.querySelector(`.fi[data-path="${CSS.escape(f.path)}"]`);loadFile(f,r);}},
   {l:'OCR',fn:()=>{const r=document.querySelector(`.fi[data-path="${CSS.escape(f.path)}"]`);loadFile(f,r).then(()=>runOCR());}},
   {l:'Flatten',fn:()=>{const r=document.querySelector(`.fi[data-path="${CSS.escape(f.path)}"]`);loadFile(f,r).then(()=>flattenPage());}}
  ].forEach(i=>{const b=document.createElement('button');b.textContent=i.l;b.addEventListener('click',()=>{m.style.display='none';i.fn();});m.appendChild(b);});
  m.style.display='block';
  const mr=m.getBoundingClientRect();
  m.style.left=Math.min(x,innerWidth-mr.width-8)+'px';
  m.style.top=Math.min(y,innerHeight-mr.height-8)+'px';
}
document.addEventListener('click',()=>document.getElementById('ctx').style.display='none');

// ═══════════════════════════════════════════════════════════════════
// FILE LOADING
// ═══════════════════════════════════════════════════════════════════
async function loadFile(entry,rowEl){
  document.querySelectorAll('.fi.act').forEach(e=>e.classList.remove('act'));
  if(rowEl)rowEl.classList.add('act');
  activeEntry=entry;
  document.getElementById('afn').textContent=entry.name;
  document.getElementById('rcur').textContent=entry.name;
  updPv();
  if(entry.ext==='pdf')await loadPDF(entry);
  else if(['png','jpg','jpeg','gif','bmp','tif','tiff','svg'].includes(entry.ext))await loadImg(entry);
  else showOther(entry);
}

// ─── PDF ─────────────────────────────────────────────────────────
async function loadPDF(entry){
  const sv=document.getElementById('sv'),tb=document.getElementById('thbar');
  destroyPages();sv.innerHTML='';tb.innerHTML='';
  const es=document.getElementById('emSt');if(es)es.remove();
  toast('Loading PDF...','in',1500);
  try{
    const file=await entry.handle.getFile();
    pdfBytes=new Uint8Array(await file.arrayBuffer());
    currentPdf=await pdfjsLib.getDocument({data:pdfBytes.slice()}).promise;
    const p1=await currentPdf.getPage(1);
    const v0=p1.getViewport({scale:1});
    scale=Math.min(Math.max((sv.clientWidth-60)/v0.width,.4),3);
    document.getElementById('zlbl').textContent=Math.round(scale*100)+'%';
    for(let i=1;i<=currentPdf.numPages;i++)await renderPg(i,sv,tb);
    const ft=tb.querySelector('.th');if(ft)ft.classList.add('on');
    toast(`${currentPdf.numPages} pages loaded`,'ok');
  }catch(e){toast('PDF error: '+e.message,'er');sv.innerHTML=`<div style="color:var(--red);padding:40px;text-align:center">${esc(e.message)}</div>`;}
}

async function renderPg(num,sv,tb){
  const page=await currentPdf.getPage(num);
  const vp=page.getViewport({scale});
  const w=Math.floor(vp.width),h=Math.floor(vp.height);

  const wrap=document.createElement('div');wrap.className='pw';wrap.id='pg-'+num;
  wrap.style.width=w+'px';wrap.style.height=h+'px';

  const pc=document.createElement('canvas');pc.className='pdf';
  pc.width=w*devicePixelRatio;pc.height=h*devicePixelRatio;
  pc.style.width=w+'px';pc.style.height=h+'px';
  wrap.appendChild(pc);
  const ctx=pc.getContext('2d');ctx.scale(devicePixelRatio,devicePixelRatio);
  await page.render({canvasContext:ctx,viewport:vp}).promise;

  const fc=document.createElement('canvas');fc.id='fb-'+num;fc.width=w;fc.height=h;
  wrap.appendChild(fc);sv.appendChild(wrap);

  const fab=new fabric.Canvas('fb-'+num,{width:w,height:h,containerClass:'canvas-container',selection:tool==='cursor'});
  hookFabric(fab,num);
  pages.push({pdfCanvas:pc,fabricInstance:fab,pageNum:num,page,rotation:0});

  // Thumb
  const tw=document.createElement('div');tw.className='th';tw.dataset.pg=num;
  const tc=document.createElement('canvas');
  const ts=100/vp.width*scale;const tvp=page.getViewport({scale:ts});
  tc.width=Math.floor(tvp.width);tc.height=Math.floor(tvp.height);
  tc.style.width='100%';tc.style.height='100%';
  await page.render({canvasContext:tc.getContext('2d'),viewport:tvp}).promise;
  tw.appendChild(tc);
  const pnl=document.createElement('span');pnl.className='pn';pnl.textContent=num;tw.appendChild(pnl);
  tw.addEventListener('click',()=>{document.querySelectorAll('.th.on').forEach(t=>t.classList.remove('on'));tw.classList.add('on');document.getElementById('pg-'+num)?.scrollIntoView({behavior:'smooth',block:'start'});});
  tb.appendChild(tw);
}

// ─── IMAGE ───────────────────────────────────────────────────────
async function loadImg(entry){
  const sv=document.getElementById('sv'),tb=document.getElementById('thbar');
  destroyPages();sv.innerHTML='';tb.innerHTML='';
  const es=document.getElementById('emSt');if(es)es.remove();
  currentPdf=null;pdfBytes=null;
  try{
    const file=await entry.handle.getFile();const url=URL.createObjectURL(file);
    const img=new Image();await new Promise((r,j)=>{img.onload=r;img.onerror=j;img.src=url;});
    scale=Math.min((sv.clientWidth-60)/img.width,2);
    document.getElementById('zlbl').textContent=Math.round(scale*100)+'%';
    const w=Math.floor(img.width*scale),h=Math.floor(img.height*scale);
    const wrap=document.createElement('div');wrap.className='pw';wrap.id='pg-1';wrap.style.width=w+'px';wrap.style.height=h+'px';
    const ic=document.createElement('canvas');ic.className='pdf';ic.width=w*devicePixelRatio;ic.height=h*devicePixelRatio;ic.style.width=w+'px';ic.style.height=h+'px';
    const ictx=ic.getContext('2d');ictx.scale(devicePixelRatio,devicePixelRatio);ictx.drawImage(img,0,0,w,h);
    wrap.appendChild(ic);
    const fc=document.createElement('canvas');fc.id='fb-1';fc.width=w;fc.height=h;wrap.appendChild(fc);
    sv.appendChild(wrap);
    const fab=new fabric.Canvas('fb-1',{width:w,height:h,containerClass:'canvas-container',selection:tool==='cursor'});
    hookFabric(fab,1);pages.push({pdfCanvas:ic,fabricInstance:fab,pageNum:1,page:null,rotation:0});
    URL.revokeObjectURL(url);toast('Image loaded','ok');
  }catch(e){toast('Image error: '+e.message,'er');}
}

function showOther(entry){
  const sv=document.getElementById('sv');destroyPages();sv.innerHTML='';currentPdf=null;pdfBytes=null;
  const t=ft(entry.name);
  sv.innerHTML=`<div style="text-align:center;padding:50px;color:var(--tx2)"><span class="material-icons-round" style="font-size:56px;color:${t.cl};display:block;margin-bottom:12px">${t.ic}</span><div style="font-size:16px;font-weight:700;margin-bottom:4px">${esc(entry.name)}</div><div style="font-size:11px">${fmtSz(entry.size)}</div><div style="margin-top:12px;color:var(--grn);font-size:12px"><span class="material-icons-round" style="font-size:14px;vertical-align:middle">check_circle</span> Handle acquired</div></div>`;
}

function destroyPages(){pages.forEach(p=>{try{p.fabricInstance.dispose();}catch{}});pages=[];countVal=0;measurements=[];updMeas();document.getElementById('countVal').textContent='0';}

// ═══════════════════════════════════════════════════════════════════
// ZOOM & NAVIGATION
// ═══════════════════════════════════════════════════════════════════
function chZoom(d){const ns=Math.min(Math.max(scale+d,.25),5);if(ns===scale)return;scale=ns;document.getElementById('zlbl').textContent=Math.round(scale*100)+'%';reRender();}
function fitW(){if(!currentPdf)return;currentPdf.getPage(1).then(p=>{const v=p.getViewport({scale:1});scale=Math.min((document.getElementById('sv').clientWidth-60)/v.width,5);document.getElementById('zlbl').textContent=Math.round(scale*100)+'%';reRender();});}

async function reRender(){
  if(!currentPdf)return;
  const saved=pages.map(p=>({n:p.pageNum,j:p.fabricInstance.toJSON(),r:p.rotation}));
  const sv=document.getElementById('sv'),tb=document.getElementById('thbar');
  destroyPages();sv.innerHTML='';tb.innerHTML='';
  for(let i=1;i<=currentPdf.numPages;i++)await renderPg(i,sv,tb);
  saved.forEach(s=>{const pg=pages.find(p=>p.pageNum===s.n);if(pg&&s.j.objects?.length)pg.fabricInstance.loadFromJSON(s.j,()=>pg.fabricInstance.renderAll());pg.rotation=s.r;});
  const ft2=tb.querySelector('.th');if(ft2)ft2.classList.add('on');
}

// Spacebar pan
document.addEventListener('keydown',e=>{
  if(e.code==='Space'&&!e.repeat&&!['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)){e.preventDefault();spaceHeld=true;document.getElementById('sv').style.cursor='grab';pages.forEach(p=>p.fabricInstance.skipTargetFind=true);}
  if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();undo();}
  if((e.ctrlKey||e.metaKey)&&e.key==='y'){e.preventDefault();redo();}
});
document.addEventListener('keyup',e=>{if(e.code==='Space'){spaceHeld=false;isPan=false;document.getElementById('sv').style.cursor='';pages.forEach(p=>p.fabricInstance.skipTargetFind=false);}});
document.addEventListener('mousedown',e=>{if(spaceHeld){isPan=true;const sv=document.getElementById('sv');panO={x:e.clientX,y:e.clientY,sx:sv.scrollLeft,sy:sv.scrollTop};sv.style.cursor='grabbing';e.preventDefault();}});
document.addEventListener('mousemove',e=>{if(isPan){const sv=document.getElementById('sv');sv.scrollLeft=panO.sx-(e.clientX-panO.x);sv.scrollTop=panO.sy-(e.clientY-panO.y);}});
document.addEventListener('mouseup',()=>{if(isPan){isPan=false;document.getElementById('sv').style.cursor=spaceHeld?'grab':'';}});
document.getElementById('sv')?.addEventListener('wheel',e=>{if(e.ctrlKey||e.metaKey){e.preventDefault();chZoom(e.deltaY>0?-.15:.15);}},{passive:false});

// Thumbnail scroll tracking
(function(){let t=false;document.getElementById('sv')?.addEventListener('scroll',()=>{if(!t){requestAnimationFrame(()=>{updThumb();t=false;});t=true;}});})();
function updThumb(){const sv=document.getElementById('sv');if(!sv||!pages.length)return;const r=sv.getBoundingClientRect(),c=r.top+r.height/3;let best=1,bd=Infinity;pages.forEach(p=>{const el=document.getElementById('pg-'+p.pageNum);if(!el)return;const d=Math.abs(el.getBoundingClientRect().top-c);if(d<bd){bd=d;best=p.pageNum;}});document.querySelectorAll('.th').forEach(t=>t.classList.toggle('on',+t.dataset.pg===best));}

// ═══════════════════════════════════════════════════════════════════
// FABRIC TOOL SYSTEM
// ═══════════════════════════════════════════════════════════════════
function hookFabric(fc,pageNum){
  applyTool(fc);

  // Undo/redo tracking
  fc.on('object:added',e=>{if(!e.target._noHistory){pushUndo({type:'add',pageNum,obj:e.target.toJSON(['_type','_measId','_countIdx'])});}});
  fc.on('object:removed',e=>{if(!e.target._noHistory){pushUndo({type:'rm',pageNum,obj:e.target.toJSON(['_type','_measId','_countIdx'])});}});

  fc.on('mouse:down',function(opt){
    const ptr=fc.getPointer(opt.e);

    if(tool==='text'&&!opt.target){
      const t=new fabric.IText('Text',{left:ptr.x,top:ptr.y,fontSize:16,fill:'#e60000',fontFamily:'Arial',fontWeight:'bold',editable:true,padding:4,_type:'text'});
      fc.add(t);fc.setActiveObject(t);t.enterEditing();fc.renderAll();
    }

    if(tool==='cloud'&&!opt.target) insertCloud(fc,ptr.x,ptr.y);

    if(tool==='callout'&&!opt.target) insertCallout(fc,ptr.x,ptr.y);

    if(tool==='eraser'&&opt.target){fc.remove(opt.target);fc.discardActiveObject();fc.renderAll();}

    if(tool==='stamp'&&!opt.target) insertStamp(fc,ptr.x,ptr.y);

    if(tool==='count'&&!opt.target){
      countVal++;
      const c=new fabric.Circle({left:ptr.x-12,top:ptr.y-12,radius:12,fill:'rgba(255,107,53,.8)',stroke:'#fff',strokeWidth:1,selectable:true,_type:'count',_countIdx:countVal});
      const lbl=new fabric.Text(String(countVal),{left:ptr.x,top:ptr.y,fontSize:12,fill:'#fff',fontFamily:'Arial',fontWeight:'bold',originX:'center',originY:'center',selectable:false,evented:false});
      fc.add(c);fc.add(lbl);fc.renderAll();
      document.getElementById('countVal').textContent=countVal;
    }

    // Arrow start
    if(tool==='arrow'&&!opt.target){
      fc._arrowStart=ptr;
    }
    // Rect start
    if(tool==='rect'&&!opt.target){
      fc._rectStart=ptr;
    }
    // Calibrate start
    if(tool==='calibrate'&&!opt.target){
      fc._calStart=ptr;
    }
    // Dimension start
    if(tool==='dimension'&&!opt.target){
      fc._dimStart=ptr;
    }
    // Polyline / Area click
    if(tool==='polyline'&&!opt.target){
      polyPts.push({x:ptr.x,y:ptr.y});
    }
    if(tool==='area'&&!opt.target){
      areaPoints.push({x:ptr.x,y:ptr.y});
    }
  });

  fc.on('mouse:up',function(opt){
    const ptr=fc.getPointer(opt.e);

    if(tool==='arrow'&&fc._arrowStart){
      const s=fc._arrowStart;
      drawArrow(fc,s.x,s.y,ptr.x,ptr.y);
      fc._arrowStart=null;
    }
    if(tool==='rect'&&fc._rectStart){
      const s=fc._rectStart;
      const r=new fabric.Rect({left:Math.min(s.x,ptr.x),top:Math.min(s.y,ptr.y),width:Math.abs(ptr.x-s.x),height:Math.abs(ptr.y-s.y),fill:'rgba(255,0,0,.06)',stroke:'#e60000',strokeWidth:2,selectable:true,_type:'rect'});
      if(r.width>5&&r.height>5)fc.add(r);
      fc._rectStart=null;fc.renderAll();
    }
    if(tool==='calibrate'&&fc._calStart){
      const s=fc._calStart;
      const px=Math.sqrt((ptr.x-s.x)**2+(ptr.y-s.y)**2);
      calLine={px,sx:s.x,sy:s.y,ex:ptr.x,ey:ptr.y};
      fc._calStart=null;
      // Show calibrate modal
      document.getElementById('calModal').classList.add('show');
    }
    if(tool==='dimension'&&fc._dimStart){
      const s=fc._dimStart;
      drawDimension(fc,s.x,s.y,ptr.x,ptr.y,pageNum);
      fc._dimStart=null;
    }
  });

  fc.on('mouse:dblclick',function(opt){
    if(tool==='polyline'&&polyPts.length>=2){
      const pts=polyPts.map(p=>[p.x,p.y]).flat();
      const pl=new fabric.Polyline(polyPts,{fill:'transparent',stroke:'#e60000',strokeWidth:2,selectable:true,_type:'polyline'});
      fc.add(pl);fc.renderAll();polyPts=[];
    }
    if(tool==='area'&&areaPoints.length>=3){
      drawAreaPolygon(fc,pageNum);
    }
  });
}

function applyTool(fc){
  fc.isDrawingMode=false;
  fc.selection=(tool==='cursor');
  fc.defaultCursor='default';fc.hoverCursor='default';
  fc.forEachObject(o=>{o.selectable=(tool==='cursor');o.evented=(tool==='cursor'||tool==='eraser');});
  if(tool==='pen'){fc.isDrawingMode=true;fc.freeDrawingBrush=new fabric.PencilBrush(fc);fc.freeDrawingBrush.color='#e60000';fc.freeDrawingBrush.width=2;fc.defaultCursor='crosshair';}
  if(tool==='highlighter'){fc.isDrawingMode=true;fc.freeDrawingBrush=new fabric.PencilBrush(fc);fc.freeDrawingBrush.color='rgba(255,255,0,.35)';fc.freeDrawingBrush.width=18;fc.defaultCursor='crosshair';}
  if(['text','cloud','callout','stamp','count'].includes(tool)){fc.defaultCursor='crosshair';fc.hoverCursor='crosshair';}
  if(['arrow','rect','calibrate','dimension','polyline','area'].includes(tool)){fc.defaultCursor='crosshair';fc.hoverCursor='crosshair';}
  if(tool==='eraser'){fc.defaultCursor='not-allowed';fc.hoverCursor='pointer';fc.forEachObject(o=>{o.selectable=false;o.evented=true;});}
  fc.renderAll();
}

function setTool(t){
  tool=t;polyPts=[];areaPoints=[];
  document.querySelectorAll('.tbtn[data-t]').forEach(b=>b.classList.toggle('on',b.dataset.t===t));
  pages.forEach(p=>applyTool(p.fabricInstance));
}

// ─── ARROW ───────────────────────────────────────────────────────
function drawArrow(fc,x1,y1,x2,y2){
  const angle=Math.atan2(y2-y1,x2-x1);
  const headLen=14;
  const line=new fabric.Line([x1,y1,x2,y2],{stroke:'#e60000',strokeWidth:2,selectable:true,_type:'arrow'});
  const head=new fabric.Triangle({left:x2,top:y2,width:headLen,height:headLen,fill:'#e60000',angle:(angle*180/Math.PI)+90,originX:'center',originY:'center',selectable:false,evented:false});
  fc.add(line);fc.add(head);fc.renderAll();
}

// ─── CLOUD ───────────────────────────────────────────────────────
function insertCloud(fc,cx,cy){
  const w=150,h=80,x=cx-w/2,y=cy-h/2,r=11;
  let d='M '+(x+r)+' '+y;
  for(let px=x+r;px<x+w-r;px+=r*2)d+=' A '+r+' '+r+' 0 0 1 '+Math.min(px+r*2,x+w-r)+' '+y;
  for(let py=y;py<y+h-r;py+=r*2)d+=' A '+r+' '+r+' 0 0 1 '+(x+w)+' '+Math.min(py+r*2,y+h);
  for(let px=x+w;px>x+r;px-=r*2)d+=' A '+r+' '+r+' 0 0 1 '+Math.max(px-r*2,x)+' '+(y+h);
  for(let py=y+h;py>y+r;py-=r*2)d+=' A '+r+' '+r+' 0 0 1 '+x+' '+Math.max(py-r*2,y);
  d+=' Z';
  const cloud=new fabric.Path(d,{fill:'rgba(255,0,0,.05)',stroke:'#e60000',strokeWidth:2,selectable:true,_type:'cloud'});
  const lbl=new fabric.IText('REV',{left:cx-14,top:cy-8,fontSize:13,fill:'#e60000',fontFamily:'Arial',fontWeight:'bold',editable:true,_type:'cloudText'});
  fc.add(cloud);fc.add(lbl);fc.setActiveObject(lbl);lbl.enterEditing();fc.renderAll();
}

// ─── CALLOUT ─────────────────────────────────────────────────────
function insertCallout(fc,cx,cy){
  const line=new fabric.Line([cx-60,cy+30,cx,cy],{stroke:'#e60000',strokeWidth:2,selectable:false,evented:false,_type:'calloutLine'});
  const txt=new fabric.IText('Note',{left:cx-80,top:cy+32,fontSize:13,fill:'#e60000',fontFamily:'Arial',fontWeight:'bold',editable:true,backgroundColor:'rgba(0,0,0,.6)',padding:4,_type:'callout'});
  fc.add(line);fc.add(txt);fc.setActiveObject(txt);txt.enterEditing();fc.renderAll();
}

// ─── STAMP ───────────────────────────────────────────────────────
async function insertStamp(fc,px,py){
  try{
    const[fh]=await window.showOpenFilePicker({types:[{description:'Images',accept:{'image/*':['.png','.jpg','.jpeg','.gif','.bmp','.svg']}}]});
    const file=await fh.getFile();const url=URL.createObjectURL(file);
    fabric.Image.fromURL(url,img=>{
      img.set({left:px-50,top:py-50,scaleX:.3,scaleY:.3,selectable:true,_type:'stamp'});
      fc.add(img);fc.setActiveObject(img);fc.renderAll();
      URL.revokeObjectURL(url);
    });
  }catch(e){if(e.name!=='AbortError')toast('Stamp: '+e.message,'er');}
}

// ─── DIMENSION LINE ──────────────────────────────────────────────
function drawDimension(fc,x1,y1,x2,y2,pgNum){
  const pxDist=Math.sqrt((x2-x1)**2+(y2-y1)**2);
  let label=''+Math.round(pxDist)+'px';
  if(calPixelsPerUnit>0){
    const real=(pxDist/calPixelsPerUnit).toFixed(2);
    label=real+' '+calUnit;
  }
  const mid={x:(x1+x2)/2,y:(y1+y2)/2};
  const line=new fabric.Line([x1,y1,x2,y2],{stroke:'#00ff00',strokeWidth:1.5,strokeDashArray:[6,3],selectable:true,_type:'dimLine'});
  const txt=new fabric.Text(label,{left:mid.x,top:mid.y-14,fontSize:11,fill:'#00ff00',fontFamily:'Arial',fontWeight:'bold',backgroundColor:'rgba(0,0,0,.7)',padding:2,selectable:false,evented:false,_type:'dimLabel'});
  fc.add(line);fc.add(txt);fc.renderAll();

  const mId=Date.now();
  measurements.push({id:mId,type:'length',value:calPixelsPerUnit>0?(pxDist/calPixelsPerUnit):pxDist,unit:calPixelsPerUnit>0?calUnit:'px',page:pgNum});
  updMeas();
}

// ─── AREA POLYGON ────────────────────────────────────────────────
function drawAreaPolygon(fc,pgNum){
  const pts=areaPoints.slice();
  const poly=new fabric.Polygon(pts,{fill:'rgba(0,255,0,.1)',stroke:'#00ff00',strokeWidth:1.5,selectable:true,_type:'areaPoly'});
  fc.add(poly);

  // Shoelace formula for area in px²
  let pxArea=0;
  for(let i=0;i<pts.length;i++){
    const j=(i+1)%pts.length;
    pxArea+=pts[i].x*pts[j].y;
    pxArea-=pts[j].x*pts[i].y;
  }
  pxArea=Math.abs(pxArea)/2;
  let label=''+Math.round(pxArea)+' px²';
  if(calPixelsPerUnit>0){
    const realArea=(pxArea/(calPixelsPerUnit**2)).toFixed(2);
    label=realArea+' sq '+calUnit;
  }

  const cx=pts.reduce((s,p)=>s+p.x,0)/pts.length;
  const cy=pts.reduce((s,p)=>s+p.y,0)/pts.length;
  const txt=new fabric.Text(label,{left:cx-30,top:cy-8,fontSize:11,fill:'#00ff00',fontFamily:'Arial',fontWeight:'bold',backgroundColor:'rgba(0,0,0,.7)',padding:2,selectable:false,evented:false,_type:'areaLabel'});
  fc.add(txt);fc.renderAll();

  const mId=Date.now();
  measurements.push({id:mId,type:'area',value:calPixelsPerUnit>0?pxArea/(calPixelsPerUnit**2):pxArea,unit:calPixelsPerUnit>0?'sq '+calUnit:'px²',page:pgNum});
  updMeas();areaPoints=[];
}

function updMeas(){
  const el=document.getElementById('measList');
  if(!measurements.length){el.textContent='No measurements';return;}
  el.innerHTML=measurements.map((m,i)=>`<div style="padding:2px 0;border-bottom:1px solid var(--bdr)">${m.type==='length'?'📏':'📐'} P${m.page}: ${m.value.toFixed?m.value.toFixed(2):m.value} ${m.unit}</div>`).join('');
}

function resetCount(){countVal=0;document.getElementById('countVal').textContent='0';toast('Count reset','in');}

// ─── CALIBRATE ───────────────────────────────────────────────────
function closeCalModal(){document.getElementById('calModal').classList.remove('show');}
function confirmCal(){
  if(!calLine){closeCalModal();return;}
  const val=parseFloat(document.getElementById('calInput').value);
  calUnit=document.getElementById('calUnitM').value;
  if(!val||val<=0){toast('Enter a valid number','er');return;}
  calPixelsPerUnit=calLine.px/val;
  document.getElementById('calVal').value=val;
  document.getElementById('calUnit').value=calUnit;
  document.getElementById('calSt').textContent='1 '+calUnit+' = '+calPixelsPerUnit.toFixed(1)+'px';
  toast('Calibrated: '+val+' '+calUnit+' = '+Math.round(calLine.px)+'px','ok');
  calLine=null;closeCalModal();setTool('cursor');
}

// ═══════════════════════════════════════════════════════════════════
// UNDO / REDO
// ═══════════════════════════════════════════════════════════════════
function pushUndo(action){undoStack.push(action);if(undoStack.length>MAX_HIST)undoStack.shift();redoStack.length=0;}

function undo(){
  if(!undoStack.length)return;
  const a=undoStack.pop();
  const pg=pages.find(p=>p.pageNum===a.pageNum);
  if(!pg)return;
  const fc=pg.fabricInstance;
  if(a.type==='add'){
    // Find and remove last matching object
    const objs=fc.getObjects();
    for(let i=objs.length-1;i>=0;i--){
      const j=objs[i].toJSON(['_type','_measId','_countIdx']);
      if(JSON.stringify(j)===JSON.stringify(a.obj)){objs[i]._noHistory=true;fc.remove(objs[i]);break;}
    }
    redoStack.push({...a,type:'rm'});
  } else {
    fabric.util.enlivenObjects([a.obj],([obj])=>{obj._noHistory=true;fc.add(obj);fc.renderAll();});
    redoStack.push({...a,type:'add'});
  }
  fc.renderAll();
}

function redo(){
  if(!redoStack.length)return;
  const a=redoStack.pop();
  const pg=pages.find(p=>p.pageNum===a.pageNum);
  if(!pg)return;
  const fc=pg.fabricInstance;
  if(a.type==='add'){
    const objs=fc.getObjects();
    for(let i=objs.length-1;i>=0;i--){
      const j=objs[i].toJSON(['_type','_measId','_countIdx']);
      if(JSON.stringify(j)===JSON.stringify(a.obj)){objs[i]._noHistory=true;fc.remove(objs[i]);break;}
    }
    undoStack.push({...a,type:'rm'});
  } else {
    fabric.util.enlivenObjects([a.obj],([obj])=>{obj._noHistory=true;fc.add(obj);fc.renderAll();});
    undoStack.push({...a,type:'add'});
  }
  fc.renderAll();
}

// ═══════════════════════════════════════════════════════════════════
// DOCUMENT OPS (pdf-lib)
// ═══════════════════════════════════════════════════════════════════
function getCurrentPageNum(){
  const sv=document.getElementById('sv');
  const r=sv.getBoundingClientRect(),c=r.top+r.height/3;
  let best=1,bd=Infinity;
  pages.forEach(p=>{const el=document.getElementById('pg-'+p.pageNum);if(!el)return;const d=Math.abs(el.getBoundingClientRect().top-c);if(d<bd){bd=d;best=p.pageNum;}});
  return best;
}

async function rotatePage(){
  if(!pdfBytes){toast('No PDF loaded','er');return;}
  const pgNum=getCurrentPageNum();
  try{
    const doc=await PDFLib.PDFDocument.load(pdfBytes);
    const pg=doc.getPage(pgNum-1);
    const cur=pg.getRotation().angle;
    pg.setRotation(PDFLib.degrees(cur+90));
    pdfBytes=new Uint8Array(await doc.save());
    currentPdf=await pdfjsLib.getDocument({data:pdfBytes.slice()}).promise;
    await reRender();
    toast('Rotated page '+pgNum+' by 90°','ok');
  }catch(e){toast('Rotate error: '+e.message,'er');}
}

async function extractPage(){
  if(!pdfBytes){toast('No PDF loaded','er');return;}
  const pgNum=getCurrentPageNum();
  try{
    const src=await PDFLib.PDFDocument.load(pdfBytes);
    const dst=await PDFLib.PDFDocument.create();
    const[copied]=await dst.copyPages(src,[pgNum-1]);
    dst.addPage(copied);
    const bytes=await dst.save();
    const blob=new Blob([bytes],{type:'application/pdf'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    a.download='page-'+pgNum+'.pdf';a.click();
    URL.revokeObjectURL(a.href);
    toast('Extracted page '+pgNum,'ok');
  }catch(e){toast('Extract error: '+e.message,'er');}
}

async function flattenPage(){
  if(!pdfBytes||!pages.length){toast('No PDF loaded','er');return;}
  const pgNum=getCurrentPageNum();
  const pg=pages.find(p=>p.pageNum===pgNum);
  if(!pg||!pg.fabricInstance.getObjects().length){toast('No markups to flatten','wr');return;}
  try{
    // Render fabric to PNG
    const dataUrl=pg.fabricInstance.toDataURL({format:'png',multiplier:2});
    const imgBytes=await fetch(dataUrl).then(r=>r.arrayBuffer());

    const doc=await PDFLib.PDFDocument.load(pdfBytes);
    const page=doc.getPage(pgNum-1);
    const{width,height}=page.getSize();
    const img=await doc.embedPng(imgBytes);
    page.drawImage(img,{x:0,y:0,width,height,opacity:1});

    pdfBytes=new Uint8Array(await doc.save());
    // Clear fabric markups
    pg.fabricInstance.clear();
    // Re-render
    currentPdf=await pdfjsLib.getDocument({data:pdfBytes.slice()}).promise;
    await reRender();
    toast('Flattened page '+pgNum,'ok');

    // Save back to file if possible
    if(activeEntry){
      try{
        const wr=await activeEntry.handle.createWritable();
        await wr.write(pdfBytes);await wr.close();
        toast('Saved to disk','ok');
      }catch(e){toast('Could not save: '+e.message,'wr');}
    }
  }catch(e){toast('Flatten error: '+e.message,'er');}
}

// ═══════════════════════════════════════════════════════════════════
// SPLIT VIEW
// ═══════════════════════════════════════════════════════════════════
function toggleSplit(){
  splitMode=!splitMode;
  const v=document.getElementById('viewer');
  if(splitMode){
    v.classList.add('split');
    // Clone scroll view
    if(!document.getElementById('sv2')){
      const sv2=document.createElement('div');sv2.className='sv';sv2.id='sv2';
      sv2.style.borderLeft='2px solid var(--org)';
      sv2.innerHTML='<div style="padding:30px;text-align:center;color:var(--tx3);font-size:12px"><span class="material-icons-round" style="font-size:40px;display:block;opacity:.3;margin-bottom:8px">vertical_split</span>Split View B<br>Load a second file or scroll independently</div>';
      v.appendChild(sv2);
    }
    document.getElementById('sv2').style.display='';
    toast('Split view ON','in');
  } else {
    v.classList.remove('split');
    const sv2=document.getElementById('sv2');
    if(sv2)sv2.style.display='none';
    toast('Split view OFF','in');
  }
}

// ═══════════════════════════════════════════════════════════════════
// OCR (Tesseract.js)
// ═══════════════════════════════════════════════════════════════════
async function runOCR(){
  if(!pages.length){toast('No document loaded','er');return;}
  const pgNum=getCurrentPageNum();
  const pg=pages.find(p=>p.pageNum===pgNum);
  if(!pg){toast('Page not found','er');return;}
  const bar=document.getElementById('ocrBar');
  const st=document.getElementById('ocrSt');
  bar.style.width='0%';st.textContent='Initializing...';
  toast('OCR starting on page '+pgNum+'...','in',2000);

  try{
    const worker=await Tesseract.createWorker('eng',1,{
      logger:m=>{
        if(m.progress!==undefined){
          const pct=Math.round(m.progress*100);
          bar.style.width=pct+'%';
          st.textContent=m.status+' '+pct+'%';
        }
      }
    });

    const canvas=pg.pdfCanvas;
    const dataUrl=canvas.toDataURL('image/png');
    const{data}=await worker.recognize(dataUrl);
    await worker.terminate();

    bar.style.width='100%';st.textContent='Done — '+data.words.length+' words found';

    // Overlay invisible text on fabric canvas
    const fc=pg.fabricInstance;
    data.words.forEach(w=>{
      if(w.confidence<30)return;
      const sx=fc.width/canvas.width*devicePixelRatio;
      const sy=fc.height/canvas.height*devicePixelRatio;
      const t=new fabric.Text(w.text,{
        left:w.bbox.x0*sx,top:w.bbox.y0*sy,
        fontSize:Math.max((w.bbox.y1-w.bbox.y0)*sy*.8,8),
        fill:'transparent',fontFamily:'Arial',
        selectable:true,evented:true,
        _type:'ocr',_noHistory:true,
      });
      fc.add(t);
    });
    fc.renderAll();
    toast('OCR complete: '+data.words.length+' words','ok');
  }catch(e){
    st.textContent='Error';toast('OCR error: '+e.message,'er');
  }
}

// ═══════════════════════════════════════════════════════════════════
// EXCEL LINK (SheetJS)
// ═══════════════════════════════════════════════════════════════════
async function linkExcel(){
  try{
    const[fh]=await window.showOpenFilePicker({types:[{description:'Excel',accept:{'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':['.xlsx','.xls']}}]});
    xlHandle=fh;
    const file=await fh.getFile();
    const buf=await file.arrayBuffer();
    const wb=XLSX.read(buf);
    xlData=wb;
    document.getElementById('xlName').textContent=fh.name;
    // Preview first sheet
    const ws=wb.Sheets[wb.SheetNames[0]];
    const json=XLSX.utils.sheet_to_json(ws,{header:1});
    document.getElementById('xlPv').innerHTML=json.slice(0,10).map(r=>'<div style="border-bottom:1px solid var(--bdr);padding:2px 0">'+r.map(c=>esc(String(c??''))).join(' | ')+'</div>').join('');
    toast('Excel loaded: '+fh.name,'ok');
  }catch(e){if(e.name!=='AbortError')toast('Excel: '+e.message,'er');}
}

async function exportXL(){
  if(!measurements.length&&!countVal){toast('No measurements to export','wr');return;}
  const wb=XLSX.utils.book_new();
  const data=[['Type','Page','Value','Unit']];
  measurements.forEach(m=>data.push([m.type,m.page,m.value,m.unit]));
  if(countVal)data.push(['count','—',countVal,'items']);
  const ws=XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb,ws,'Measurements');
  const buf=XLSX.write(wb,{bookType:'xlsx',type:'array'});
  const blob=new Blob([buf],{type:'application/octet-stream'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='measurements.xlsx';a.click();
  URL.revokeObjectURL(a.href);
  toast('Exported measurements','ok');
}

// ═══════════════════════════════════════════════════════════════════
// RENAMING ENGINE
// ═══════════════════════════════════════════════════════════════════
// Build taxonomy chips
(function(){
  Object.entries(TAX_DATA).forEach(([field,vals])=>{
    const container=document.getElementById('c'+field.charAt(0).toUpperCase()+field.slice(1));
    if(!container)return;
    vals.forEach(v=>{
      const c=document.createElement('span');c.className='chip';c.dataset.f=field;c.dataset.v=v;c.textContent=v;
      c.addEventListener('click',()=>{
        if(tax[field]===v){tax[field]='';c.classList.remove('on');}
        else{container.querySelectorAll('.chip').forEach(x=>x.classList.remove('on'));tax[field]=v;c.classList.add('on');}
        updPv();
      });
      container.appendChild(c);
    });
  });
})();

function setToday(){const d=new Date();const s=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');document.getElementById('txDt').value=s;tax.date=s.replace(/-/g,'');updPv();}
document.getElementById('txDt').addEventListener('change',e=>{tax.date=e.target.value?e.target.value.replace(/-/g,''):'';updPv();});

function updPv(){
  tax.client=document.getElementById('txCl').value.trim().toUpperCase();
  tax.job=document.getElementById('txJb').value.trim().toUpperCase();
  tax.desc=document.getElementById('txDs').value.trim().replace(/\s+/g,'-');
  const name=buildName();
  const el=document.getElementById('rpv'),btn=document.getElementById('renBtn');
  if(name){el.textContent=name;el.style.color='';btn.disabled=false;}
  else{el.textContent=activeEntry?'(select segments)':'—';el.style.color='var(--tx3)';btn.disabled=true;}
}

function buildName(){
  if(!activeEntry)return'';
  const ext=fext(activeEntry.name);
  const segs=[tax.class,tax.rev,tax.ver,tax.spec,tax.date,tax.client,tax.job,tax.desc].filter(s=>s);
  if(!segs.length)return'';
  return ext?segs.join('-')+'.'+ext:segs.join('-');
}

async function doRename(){
  if(!activeEntry)return toast('No file','er');
  const nn=buildName();if(!nn)return toast('Build name first','er');
  if(nn===activeEntry.name)return toast('Same name','wr');
  const old=activeEntry.name,par=activeEntry.parentHandle;
  try{
    const f=await activeEntry.handle.getFile(),buf=await f.arrayBuffer();
    const nh=await par.getFileHandle(nn,{create:true});
    const w=await nh.createWritable();await w.write(buf);await w.close();
    await par.removeEntry(old);
    renHist.unshift({o:old,n:nn});if(renHist.length>30)renHist.length=30;
    renderHist();toast(old+' → '+nn,'ok',4000);
    await scanFiles();
    const re=allFiles.find(f=>f.name===nn);
    if(re){const row=document.querySelector('.fi[data-path="'+CSS.escape(re.path)+'"]');if(row)loadFile(re,row);}
  }catch(e){toast('Rename: '+e.message,'er');}
}

function clrTax(){
  Object.keys(tax).forEach(k=>tax[k]='');
  document.querySelectorAll('.chip.on').forEach(c=>c.classList.remove('on'));
  ['txDt','txCl','txJb','txDs'].forEach(id=>document.getElementById(id).value='');
  updPv();
}

function renderHist(){
  const el=document.getElementById('rHist');el.innerHTML='';
  renHist.forEach(h=>{const d=document.createElement('div');d.className='hi';d.innerHTML=`<span class="ho" title="${esc(h.o)}">${esc(h.o)}</span><span style="color:var(--tx3);flex-shrink:0">→</span><span class="hn" title="${esc(h.n)}">${esc(h.n)}</span>`;el.appendChild(d);});
}

// ─── RIGHT PANEL TABS ────────────────────────────────────────────
function showTab(tab){
  document.querySelectorAll('.rtab').forEach(t=>t.classList.toggle('on',t.dataset.tab===tab));
  document.querySelectorAll('.rpane').forEach(p=>p.classList.toggle('on',p.id==='pane-'+tab));
}

// ─── INIT ────────────────────────────────────────────────────────
if(!('showDirectoryPicker' in window))toast('Use Chrome 86+ or Edge 86+','wr',8000);
</script>
</body>
</html>
